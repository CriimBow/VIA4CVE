#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Source file for the Exploit-DB information
#   Note: This information has to be mapped to refmap, as the source
#         does not contain cve IDs
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2016 	Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Sources
SOURCE_NAME = 'exploitdb'
SOURCE_FILE = "https://github.com/offensive-security/exploit-database/raw/master/files.csv"

# Imports
import csv
import zipfile

from io          import StringIO
from lib.Config  import Configuration as conf
from lib.Source  import Source

class ExploitDB(Source):
  def __init__(self):
    self.name = SOURCE_NAME
    self.cves = {}
    self.exploits = {}

    _file, r = conf.getFeedData(SOURCE_NAME, SOURCE_FILE)
    exploits={}
    exploitcsv = csv.DictReader(StringIO(_file.decode('utf-8')), delimiter=',')
    for row in exploitcsv:
      self.exploits[row['id']] = row


  def updateRefs(self, cveID, cveData):
    # Map exploit-db id's to refmap id's
    for exploitID in cveData.get('refmap', {}).get('exploit-db', []):
      if 'exploit-db' not in cveData: cveData['exploit-db'] = []
      if exploitID in self.exploits.keys():
        cveData['exploit-db'].append(self.exploits[exploitID])
      else:
        cveData['exploit-db'].append({'id': exploitID})

  def cleanUp(self, cveID, cveData):
    if cveData.get('refmap', {}).get('exploit-db'):
      del cveData['refmap']['exploit-db']
